<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能网盘直链转换器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        .background-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0;
        }

        .floating-shape {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            animation: float 6s ease-in-out infinite;
        }

        .floating-shape:nth-child(1) {
            width: 100px;
            height: 100px;
            top: 20%;
            left: 20%;
            animation-delay: 0s;
        }

        .floating-shape:nth-child(2) {
            width: 150px;
            height: 150px;
            top: 60%;
            right: 20%;
            animation-delay: 2s;
        }

        .floating-shape:nth-child(3) {
            width: 80px;
            height: 80px;
            bottom: 20%;
            left: 30%;
            animation-delay: 4s;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px) rotate(0deg);
            }

            50% {
                transform: translateY(-20px) rotate(180deg);
            }
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px;
            max-width: 650px;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 1;
            animation: slideUp 0.8s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: white;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
            font-weight: 400;
        }

        .platform-indicators {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .platform-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .platform-badge:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .input-section {
            margin-bottom: 30px;
        }

        .input-wrapper {
            position: relative;
            margin-bottom: 20px;
        }

        .input-field {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
            outline: none;
        }

        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .input-field:focus {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .convert-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .convert-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(255, 107, 107, 0.3);
        }

        .convert-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .convert-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .convert-btn:hover::before {
            left: 100%;
        }

        .result-section {
            margin-top: 30px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        }

        .result-section.show {
            opacity: 1;
            transform: translateY(0);
        }

        .result-wrapper {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .result-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .result-link {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px;
            color: white;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            word-break: break-all;
            margin-bottom: 15px;
            position: relative;
            max-height: 120px;
            overflow-y: auto;
        }

        .copy-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .test-btn {
            background: rgba(76, 175, 80, 0.2);
            color: white;
            border: 1px solid rgba(76, 175, 80, 0.5);
            border-radius: 10px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .test-btn:hover {
            background: rgba(76, 175, 80, 0.3);
            transform: translateY(-1px);
        }

        .detection-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
        }

        .detection-info h3 {
            color: white;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .detection-info p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        .error-message {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.5);
            border-radius: 12px;
            padding: 15px;
            color: white;
            margin-top: 15px;
            border-left: 4px solid #f44336;
        }

        .warning-message {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.5);
            border-radius: 12px;
            padding: 15px;
            color: white;
            margin-top: 15px;
            border-left: 4px solid #ffc107;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .password-section {
            margin-bottom: 20px;
            animation: slideDown 0.3s ease-out;
        }

        .password-hint {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
            margin-top: 8px;
            padding-left: 10px;
        }

        .options-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            cursor: pointer;
            user-select: none;
        }

        .checkbox-wrapper input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }

        .short-link-info {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid rgba(33, 150, 243, 0.5);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }

        .batch-progress {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.3s ease;
        }

        .batch-results {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .batch-item {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85rem;
        }

        .batch-item.success {
            color: #4CAF50;
        }

        .batch-item.error {
            color: #f44336;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                max-height: 100px;
                transform: translateY(0);
            }
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 30px 20px;
                margin: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .platform-indicators {
                gap: 8px;
            }

            .platform-badge {
                padding: 4px 8px;
                font-size: 0.7rem;
            }
        }
    </style>
</head>

<body>
    <div class="background-animation">
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
        <div class="floating-shape"></div>
    </div>

    <div class="container">
        <div class="header">
            <h1>🔗 智能直链转换器</h1>
            <p>支持主流网盘分享链接一键转换为直接下载链接</p>
        </div>

        <div class="platform-indicators">
            <div class="platform-badge">Google Drive</div>
            <div class="platform-badge">OneDrive</div>
            <div class="platform-badge">Dropbox</div>
            <div class="platform-badge">百度网盘</div>
            <div class="platform-badge">蓝奏云</div>
            <div class="platform-badge">天翼云</div>
            <div class="platform-badge">阿里云盘</div>
            <div class="platform-badge">夸克网盘</div>
            <div class="platform-badge">123云盘</div>
            <div class="platform-badge">城通网盘</div>
            <div class="platform-badge">MediaFire</div>
            <div class="platform-badge">MEGA</div>
            <div class="platform-badge">4shared</div>
            <div class="platform-badge">坚果云</div>
            <div class="platform-badge">TeraBox</div>
            <div class="platform-badge">WeTransfer</div>
            <div class="platform-badge">短链接展开</div>
        </div>

        <div class="input-section">
            <div class="input-wrapper">
                <input type="text" class="input-field" id="shareLink" placeholder="请粘贴网盘分享链接...">
            </div>

            <!-- 密码输入区域 -->
            <div class="password-section" id="passwordSection" style="display: none;">
                <div class="input-wrapper">
                    <input type="text" class="input-field" id="extractCode" placeholder="请输入提取码/密码...">
                </div>
                <div class="password-hint" id="passwordHint"></div>
            </div>

            <!-- 短链接展开选项 -->
            <div class="options-section">
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="expandShortLinks" checked>
                    <span class="checkmark"></span>
                    自动展开短链接
                </label>
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="batchMode">
                    <span class="checkmark"></span>
                    批量处理模式
                </label>
            </div>

            <button class="convert-btn" onclick="convertLink()">
                <span id="convertText">🚀 智能转换</span>
            </button>
        </div>

        <!-- 短链接展开信息 -->
        <div id="shortLinkInfo" class="short-link-info" style="display: none;">
            <h3>🔗 短链接展开</h3>
            <p id="shortLinkDetails"></p>
        </div>

        <!-- 批量处理进度 -->
        <div id="batchProgress" class="batch-progress">
            <h3>📊 批量处理进度</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="batchStatus">准备中...</div>
            <div class="batch-results" id="batchResults"></div>
        </div>

        <div class="result-section" id="resultSection">
            <div id="detectionInfo" class="detection-info" style="display: none;">
                <h3 id="detectedPlatform"></h3>
                <p id="detectedType"></p>
            </div>

            <div class="result-wrapper">
                <div class="result-label">直接下载链接：</div>
                <div class="result-link" id="resultLink"></div>
                <button class="copy-btn" onclick="copyToClipboard()">📋 复制链接</button>
                <button class="test-btn" onclick="testLink()">🔍 测试链接</button>
                <button class="copy-btn" onclick="copyAllResults()" id="copyAllBtn" style="display: none;">📋
                    复制全部</button>
                <button class="test-btn" onclick="testAllLinks()" id="testAllBtn" style="display: none;">🔍
                    测试全部</button>
            </div>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;"></div>
        <div id="warningMessage" class="warning-message" style="display: none;"></div>

        <div class="footer">
            <p>💡 支持自动识别网盘类型 • 一键转换 • 安全可靠</p>
        </div>
    </div>

    <script>
        // 短链接服务配置
        const shortLinkServices = {
            'bit.ly': {
                name: 'Bitly',
                expandUrl: 'https://api.bitly.com/v4/expand',
                method: 'POST'
            },
            'tinyurl.com': {
                name: 'TinyURL',
                expandUrl: 'https://tinyurl.com/api-create.php?alias=',
                method: 'GET'
            },
            't.co': {
                name: 'Twitter',
                expandUrl: 'https://t.co/',
                method: 'HEAD'
            },
            'short.link': {
                name: 'Short.link',
                expandUrl: 'https://short.link/api/expand',
                method: 'GET'
            },
            'is.gd': {
                name: 'Is.gd',
                expandUrl: 'https://is.gd/forward.php?format=simple&shorturl=',
                method: 'GET'
            }
        };

        // 网盘平台配置
        const platforms = {
            'drive.google.com': {
                name: 'Google Drive',
                icon: '🗂️',
                patterns: [
                    {
                        regex: /drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/,
                        converter: (match) => `https://drive.google.com/uc?export=download&id=${match[1]}`
                    },
                    {
                        regex: /drive\.google\.com\/open\?id=([a-zA-Z0-9_-]+)/,
                        converter: (match) => `https://drive.google.com/uc?export=download&id=${match[1]}`
                    }
                ]
            },
            'onedrive.live.com': {
                name: 'OneDrive',
                icon: '☁️',
                patterns: [
                    {
                        regex: /onedrive\.live\.com\/.*redir\?resid=([^&]+)/,
                        converter: (match) => `https://onedrive.live.com/download?resid=${match[1]}`
                    },
                    {
                        regex: /1drv\.ms\/[a-zA-Z]\/([a-zA-Z0-9_-]+)/,
                        converter: (match, originalUrl) => {
                            // 先重定向到原始链接，然后转换
                            return originalUrl.replace('1drv.ms', 'onedrive.live.com/download?cid=');
                        }
                    },
                    {
                        regex: /onedrive\.live\.com\/.*\/([a-zA-Z0-9_-]+)\.([a-zA-Z0-9]+)\?/,
                        converter: (match, originalUrl) => originalUrl.replace('redir?', 'download?')
                    }
                ]
            },
            'dropbox.com': {
                name: 'Dropbox',
                icon: '📦',
                patterns: [
                    {
                        regex: /dropbox\.com\/s\/([a-zA-Z0-9_-]+)/,
                        converter: (match, originalUrl) => {
                            return originalUrl.replace('www.dropbox.com', 'dl.dropboxusercontent.com')
                                .replace('dropbox.com', 'dl.dropboxusercontent.com')
                                .replace('?dl=0', '')
                                .replace('?dl=1', '');
                        }
                    },
                    {
                        regex: /dropbox\.com\/scl\/fi\/([^?]+)/,
                        converter: (match, originalUrl) => {
                            return originalUrl.replace('www.dropbox.com', 'dl.dropboxusercontent.com')
                                .replace('dropbox.com', 'dl.dropboxusercontent.com')
                                .replace('?dl=0', '')
                                .replace('?dl=1', '');
                        }
                    }
                ]
            },
            'pan.baidu.com': {
                name: '百度网盘',
                icon: '💾',
                needsPassword: true,
                requiresSpecialHandling: true,
                patterns: [
                    {
                        regex: /pan\.baidu\.com\/s\/([a-zA-Z0-9_-]+)/,
                        converter: async (match, originalUrl, password) => {
                            const shareId = match[1];
                            if (password) {
                                // 尝试通过第三方解析服务
                                return await parseBaiduPan(shareId, password, originalUrl);
                            }
                            return {
                                type: 'redirect',
                                url: originalUrl,
                                message: '请手动访问链接并输入提取码'
                            };
                        }
                    }
                ]
            },
            'lanzou.com': {
                name: '蓝奏云',
                icon: '🌥️',
                needsPassword: false, // 改为可选
                requiresSpecialHandling: true,
                patterns: [
                    {
                        regex: /lanzou[a-z]?\.com\/([a-zA-Z0-9_-]+)/,
                        converter: async (match, originalUrl, password) => {
                            const fileId = match[1];
                            return await parseLanzouCloud(fileId, originalUrl, password);
                        }
                    },
                    {
                        regex: /lanzou[a-z]?\.com\/i([a-zA-Z0-9_-]+)/,
                        converter: async (match, originalUrl, password) => {
                            const fileId = match[1];
                            return await parseLanzouCloud('i' + fileId, originalUrl, password);
                        }
                    }
                ]
            },
            'cloud.189.cn': {
                name: '天翼云',
                icon: '☁️',
                patterns: [
                    {
                        regex: /cloud\.189\.cn\/t\/([a-zA-Z0-9_-]+)/,
                        converter: (match, originalUrl) => {
                            const shareId = match[1];
                            return `https://cloud.189.cn/api/open/file/getFileDownloadUrl.action?shareId=${shareId}`;
                        }
                    }
                ]
            },
            'aliyundrive.com': {
                name: '阿里云盘',
                icon: '💿',
                patterns: [
                    {
                        regex: /aliyundrive\.com\/s\/([a-zA-Z0-9_-]+)/,
                        converter: (match, originalUrl) => {
                            const shareId = match[1];
                            return `https://api.aliyundrive.com/v2/file/get_download_url?share_id=${shareId}`;
                        }
                    }
                ]
            },
            'pan.quark.cn': {
                name: '夸克网盘',
                icon: '🚀',
                patterns: [
                    {
                        regex: /pan\.quark\.cn\/s\/([a-zA-Z0-9_-]+)/,
                        converter: (match, originalUrl) => {
                            const shareId = match[1];
                            return `https://pan.quark.cn/api/file/share/download?share_id=${shareId}`;
                        }
                    }
                ]
            },
            '123pan.com': {
                name: '123云盘',
                icon: '📊',
                patterns: [
                    {
                        regex: /123pan\.com\/s\/([a-zA-Z0-9_-]+)/,
                        converter: (match, originalUrl) => {
                            const shareId = match[1];
                            return `https://123pan.com/api/file/download_info?share_key=${shareId}`;
                        }
                    }
                ]
            },
            'ctfile.com': {
                name: '城通网盘',
                icon: '🏰',
                patterns: [
                    {
                        regex: /ctfile\.com\/f\/([a-zA-Z0-9_-]+)/,
                        converter: (match, originalUrl) => {
                            const fileId = match[1];
                            return `https://webapi.ctfile.com/getfile.php?path=${fileId}`;
                        }
                    }
                ]
            },
            'weiyun.com': {
                name: '微云',
                icon: '☁️',
                patterns: [
                    {
                        regex: /weiyun\.com\/([a-zA-Z0-9_-]+)/,
                        converter: (match, originalUrl) => {
                            const shareId = match[1];
                            return `https://weiyun.com/api/share/download?share_key=${shareId}`;
                        }
                    }
                ]
            },
            'cowtransfer.com': {
                name: '奶牛快传',
                icon: '🐄',
                patterns: [
                    {
                        regex: /cowtransfer\.com\/s\/([a-zA-Z0-9_-]+)/,
                        converter: (match, originalUrl) => {
                            const shareId = match[1];
                            return `https://cowtransfer.com/api/transfer/download?transferId=${shareId}`;
                        }
                    }
                ]
            }
        };

        let currentResult = '';
        let currentPlatform = '';

        async function convertLink() {
            const input = document.getElementById('shareLink');
            const url = input.value.trim();
            const batchMode = document.getElementById('batchMode').checked;
            const expandShortLinks = document.getElementById('expandShortLinks').checked;
            const convertBtn = document.querySelector('.convert-btn');
            const convertText = document.getElementById('convertText');
            const resultSection = document.getElementById('resultSection');
            const errorMessage = document.getElementById('errorMessage');
            const warningMessage = document.getElementById('warningMessage');
            const detectionInfo = document.getElementById('detectionInfo');
            const shortLinkInfo = document.getElementById('shortLinkInfo');
            const batchProgress = document.getElementById('batchProgress');

            // 清除之前的结果
            errorMessage.style.display = 'none';
            warningMessage.style.display = 'none';
            resultSection.classList.remove('show');
            detectionInfo.style.display = 'none';
            shortLinkInfo.style.display = 'none';
            batchProgress.style.display = 'none';

            if (!url) {
                showError('请输入网盘分享链接');
                return;
            }

            // 检查是否为批量模式
            if (batchMode || url.includes('\n')) {
                await processBatchLinks(url);
                return;
            }

            // 显示加载状态
            convertText.innerHTML = '<span class="loading"></span>转换中...';
            convertBtn.disabled = true;

            try {
                let processedUrl = url;

                // 短链接展开
                if (expandShortLinks && isShortLink(url)) {
                    showShortLinkInfo('正在展开短链接...');
                    processedUrl = await expandShortLink(url);
                    if (processedUrl !== url) {
                        showShortLinkInfo(`短链接已展开: ${processedUrl.substring(0, 50)}...`);
                    }
                }

                if (!isValidUrl(processedUrl)) {
                    showError('请输入有效的网盘链接');
                    return;
                }

                const result = await processLink(processedUrl);
                if (result.success) {
                    showResult(result);
                    if (result.warning) {
                        showWarning(result.warning);
                    }
                } else {
                    showError(result.error);
                }
            } catch (error) {
                showError('转换失败，请检查链接格式: ' + error.message);
            } finally {
                // 恢复按钮状态
                convertText.innerHTML = '🚀 智能转换';
                convertBtn.disabled = false;
            }
        }

        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        // 短链接检测
        function isShortLink(url) {
            const shortDomains = Object.keys(shortLinkServices);
            return shortDomains.some(domain => url.includes(domain));
        }

        // 短链接展开
        async function expandShortLink(url) {
            try {
                // 使用通用的重定向跟踪方法
                const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                if (response.ok) {
                    const data = await response.json();
                    // 尝试从响应中提取重定向URL
                    const redirectMatch = data.contents.match(/location\.href\s*=\s*["']([^"']+)["']/i);
                    if (redirectMatch) {
                        return redirectMatch[1];
                    }
                }

                // 备用方法：尝试直接访问并获取最终URL
                return await expandUrlFallback(url);
            } catch (error) {
                console.warn('短链接展开失败:', error);
                return url; // 返回原始URL
            }
        }

        // 备用展开方法
        async function expandUrlFallback(url) {
            try {
                // 创建一个隐藏的iframe来获取最终URL
                return new Promise((resolve) => {
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.onload = () => {
                        try {
                            const finalUrl = iframe.contentWindow.location.href;
                            document.body.removeChild(iframe);
                            resolve(finalUrl !== 'about:blank' ? finalUrl : url);
                        } catch (e) {
                            document.body.removeChild(iframe);
                            resolve(url);
                        }
                    };
                    iframe.onerror = () => {
                        document.body.removeChild(iframe);
                        resolve(url);
                    };
                    document.body.appendChild(iframe);
                    iframe.src = url;

                    // 超时处理
                    setTimeout(() => {
                        if (iframe.parentNode) {
                            document.body.removeChild(iframe);
                            resolve(url);
                        }
                    }, 5000);
                });
            } catch (error) {
                return url;
            }
        }

        // 显示短链接信息
        function showShortLinkInfo(message) {
            const shortLinkInfo = document.getElementById('shortLinkInfo');
            const shortLinkDetails = document.getElementById('shortLinkDetails');
            shortLinkDetails.textContent = message;
            shortLinkInfo.style.display = 'block';
        }

        // 百度网盘解析
        async function parseBaiduPan(shareId, password, originalUrl) {
            try {
                // 方法1: 生成实用的访问链接
                const accessUrls = [
                    // 直接访问分享页面
                    originalUrl,
                    // 移动端访问（有时更容易获取下载链接）
                    `https://pan.baidu.com/mbox/msg/share?uk=0&shareid=${shareId}&pwd=${password}`,
                    // API接口（需要进一步处理）
                    `https://pan.baidu.com/api/sharedownload?shareid=${shareId}&pwd=${password}`
                ];

                // 方法2: 提供实用的使用说明
                const instructions = [
                    "1. 点击第一个链接访问分享页面",
                    "2. 输入提取码: " + password,
                    "3. 选择文件后点击下载",
                    "4. 如果第一个链接无效，请尝试其他链接"
                ];

                return {
                    type: 'multiple',
                    urls: accessUrls,
                    message: '百度网盘需要手动操作，请按以下步骤：\n' + instructions.join('\n')
                };

            } catch (error) {
                return {
                    type: 'error',
                    message: '百度网盘解析失败，建议直接访问原链接'
                };
            }
        }

        // 蓝奏云解析
        async function parseLanzouCloud(fileId, originalUrl, password) {
            try {
                // 提取域名和文件ID
                const urlMatch = originalUrl.match(/https?:\/\/([^\/]+)\/(.+)/);
                if (!urlMatch) {
                    throw new Error('无效的蓝奏云链接');
                }

                const domain = urlMatch[1];
                const path = urlMatch[2];

                // 生成多种可能的访问方式
                const accessMethods = [
                    {
                        url: originalUrl,
                        description: "原始分享链接（推荐）"
                    },
                    {
                        url: `https://${domain}/tp/${path}`,
                        description: "直接下载链接1"
                    },
                    {
                        url: `https://${domain}/file/${path}`,
                        description: "直接下载链接2"
                    }
                ];

                // 如果有密码，添加带密码的链接
                if (password) {
                    accessMethods.push({
                        url: `${originalUrl}?pwd=${password}`,
                        description: "带密码的分享链接"
                    });
                }

                // 添加一些常用的蓝奏云镜像域名
                const mirrorDomains = ['lanzous.com', 'lanzoux.com', 'lanzoui.com'];
                mirrorDomains.forEach(mirror => {
                    if (mirror !== domain) {
                        accessMethods.push({
                            url: `https://${mirror}/${path}`,
                            description: `镜像链接 (${mirror})`
                        });
                    }
                });

                const urls = accessMethods.map(method => method.url);
                const descriptions = accessMethods.map((method, index) =>
                    `${index + 1}. ${method.description}: ${method.url}`
                ).join('\n');

                return {
                    type: 'multiple',
                    urls: urls,
                    message: `蓝奏云多链接解析完成：\n${descriptions}\n\n建议优先尝试第一个链接`
                };

            } catch (error) {
                return {
                    type: 'error',
                    message: '蓝奏云解析失败: ' + error.message
                };
            }
        }

        // 天翼云解析
        async function parseCloud189(shareId, originalUrl, password) {
            try {
                // 天翼云的API调用需要复杂的认证
                const apiUrls = [
                    `https://cloud.189.cn/api/open/file/getFileDownloadUrl.action?shareId=${shareId}`,
                    `https://cloud.189.cn/api/portal/getFileInfo.action?shareId=${shareId}`
                ];

                return {
                    type: 'multiple',
                    urls: apiUrls,
                    message: '天翼云需要登录认证，建议手动下载'
                };
            } catch (error) {
                return {
                    type: 'error',
                    message: '天翼云解析失败'
                };
            }
        }

        async function processLink(url) {
            const extractCode = document.getElementById('extractCode').value.trim();

            // 检测平台
            for (const [domain, platform] of Object.entries(platforms)) {
                if (url.includes(domain)) {
                    // 检查是否需要密码
                    if (platform.needsPassword && !extractCode) {
                        showPasswordSection(platform.name);
                        return {
                            success: false,
                            error: `${platform.name} 需要提取码，请输入后重试`
                        };
                    }

                    // 尝试匹配模式
                    for (const pattern of platform.patterns) {
                        const match = url.match(pattern.regex);
                        if (match) {
                            let result;

                            // 检查是否需要特殊处理
                            if (platform.requiresSpecialHandling) {
                                result = await pattern.converter(match, url, extractCode);

                                // 处理特殊返回类型
                                if (typeof result === 'object' && result.type) {
                                    return await handleSpecialResult(result, platform, url);
                                }
                            } else {
                                result = pattern.converter(match, url, extractCode);
                            }

                            const directLink = typeof result === 'string' ? result : result.url || result;
                            let warning = null;

                            // 为某些平台添加警告信息
                            if (domain === 'pan.baidu.com') {
                                warning = extractCode ?
                                    '百度网盘解析完成，如链接无效请尝试手动下载' :
                                    '百度网盘需要提取码，请输入后重试';
                            } else if (domain.includes('lanzou')) {
                                warning = '蓝奏云解析完成，如链接无效请尝试其他链接';
                            } else if (domain === 'cloud.189.cn' || domain === 'aliyundrive.com' || domain === 'pan.quark.cn') {
                                warning = '此链接为API接口，需要相应的认证才能直接下载';
                            }

                            return {
                                success: true,
                                platform: platform.name,
                                icon: platform.icon,
                                directLink: directLink,
                                originalUrl: url,
                                warning: warning,
                                hasPassword: !!extractCode
                            };
                        }
                    }
                }
            }

            // 尝试通用转换
            const genericResult = tryGenericConversion(url);
            if (genericResult.success) {
                return genericResult;
            }

            return {
                success: false,
                error: '暂不支持该网盘或链接格式不正确'
            };
        }

        function tryGenericConversion(url) {
            // 尝试一些通用的转换方法
            if (url.includes('?dl=0')) {
                return {
                    success: true,
                    platform: '通用转换',
                    icon: '🔄',
                    directLink: url.replace('?dl=0', '?dl=1'),
                    originalUrl: url,
                    warning: '已尝试通用转换，可能需要手动验证'
                };
            }

            if (url.includes('drive.google.com') && url.includes('view?usp=sharing')) {
                const fileId = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
                if (fileId) {
                    return {
                        success: true,
                        platform: 'Google Drive',
                        icon: '🗂️',
                        directLink: `https://drive.google.com/uc?export=download&id=${fileId[1]}`,
                        originalUrl: url
                    };
                }
            }

            return { success: false };
        }

        // 处理特殊解析结果
        async function handleSpecialResult(result, platform, originalUrl) {
            switch (result.type) {
                case 'multiple':
                    // 多个可能的链接
                    return {
                        success: true,
                        platform: platform.name,
                        icon: platform.icon,
                        directLink: result.urls.join('\n'),
                        originalUrl: originalUrl,
                        warning: result.message,
                        isMultiple: true
                    };

                case 'needPassword':
                    // 需要密码
                    showPasswordSection(platform.name);
                    return {
                        success: false,
                        error: result.message
                    };

                case 'redirect':
                    // 需要重定向
                    return {
                        success: true,
                        platform: platform.name,
                        icon: platform.icon,
                        directLink: result.url,
                        originalUrl: originalUrl,
                        warning: result.message,
                        isRedirect: true
                    };

                case 'error':
                    // 解析错误
                    return {
                        success: false,
                        error: result.message
                    };

                default:
                    return {
                        success: false,
                        error: '未知的解析结果类型'
                    };
            }
        }

        function showResult(result) {
            const resultSection = document.getElementById('resultSection');
            const resultLink = document.getElementById('resultLink');
            const detectionInfo = document.getElementById('detectionInfo');
            const detectedPlatform = document.getElementById('detectedPlatform');
            const detectedType = document.getElementById('detectedType');
            const copyAllBtn = document.getElementById('copyAllBtn');
            const testAllBtn = document.getElementById('testAllBtn');

            // 显示检测信息
            detectedPlatform.textContent = `${result.icon} ${result.platform}`;

            if (result.isMultiple) {
                detectedType.textContent = '已生成多个可能的下载链接，请逐个尝试';
                copyAllBtn.style.display = 'inline-block';
                testAllBtn.style.display = 'inline-block';
            } else if (result.isRedirect) {
                detectedType.textContent = '需要手动访问链接完成下载';
            } else {
                detectedType.textContent = '已自动识别平台并转换为直链';
            }

            detectionInfo.style.display = 'block';

            // 显示结果
            if (result.isMultiple) {
                // 多链接格式化显示
                const links = result.directLink.split('\n');
                resultLink.innerHTML = links.map((link, index) =>
                    `<div style="margin-bottom: 8px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 6px;">
                        <strong>链接 ${index + 1}:</strong><br>
                        <span style="font-size: 0.85em; word-break: break-all;">${link}</span>
                    </div>`
                ).join('');
            } else {
                resultLink.textContent = result.directLink;
            }

            currentResult = result.directLink;
            currentPlatform = result.platform;

            resultSection.classList.add('show');
        }

        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function showWarning(message) {
            const warningMessage = document.getElementById('warningMessage');
            warningMessage.textContent = `⚠️ ${message}`;
            warningMessage.style.display = 'block';
        }

        // 显示密码输入区域
        function showPasswordSection(platformName) {
            const passwordSection = document.getElementById('passwordSection');
            const passwordHint = document.getElementById('passwordHint');
            passwordHint.textContent = `检测到 ${platformName}，请输入提取码或密码`;
            passwordSection.style.display = 'block';
        }

        // 隐藏密码输入区域
        function hidePasswordSection() {
            const passwordSection = document.getElementById('passwordSection');
            passwordSection.style.display = 'none';
        }

        // 批量处理链接
        async function processBatchLinks(input) {
            const urls = input.split('\n').filter(url => url.trim());
            if (urls.length <= 1) {
                showError('批量模式需要多个链接，每行一个');
                return;
            }

            const batchProgress = document.getElementById('batchProgress');
            const progressFill = document.getElementById('progressFill');
            const batchStatus = document.getElementById('batchStatus');
            const batchResults = document.getElementById('batchResults');
            const copyAllBtn = document.getElementById('copyAllBtn');

            batchProgress.style.display = 'block';
            batchResults.innerHTML = '';

            const results = [];
            let successCount = 0;
            let errorCount = 0;

            for (let i = 0; i < urls.length; i++) {
                const url = urls[i].trim();
                const progress = ((i + 1) / urls.length) * 100;

                progressFill.style.width = `${progress}%`;
                batchStatus.textContent = `处理中 ${i + 1}/${urls.length}: ${url.substring(0, 30)}...`;

                try {
                    let processedUrl = url;

                    // 短链接展开
                    if (document.getElementById('expandShortLinks').checked && isShortLink(url)) {
                        processedUrl = await expandShortLink(url);
                    }

                    const result = await processLink(processedUrl);

                    if (result.success) {
                        results.push(result.directLink);
                        successCount++;
                        addBatchResult(url, result.directLink, 'success');
                    } else {
                        errorCount++;
                        addBatchResult(url, result.error, 'error');
                    }
                } catch (error) {
                    errorCount++;
                    addBatchResult(url, '转换失败: ' + error.message, 'error');
                }

                // 添加延迟避免请求过快
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            batchStatus.textContent = `完成！成功: ${successCount}, 失败: ${errorCount}`;

            if (results.length > 0) {
                currentResult = results.join('\n');
                copyAllBtn.style.display = 'inline-block';
                document.getElementById('resultLink').textContent = `批量转换完成，共 ${results.length} 个链接`;
                document.getElementById('resultSection').classList.add('show');
            }
        }

        // 添加批量结果项
        function addBatchResult(originalUrl, result, type) {
            const batchResults = document.getElementById('batchResults');
            const item = document.createElement('div');
            item.className = `batch-item ${type}`;
            item.innerHTML = `
                <strong>${originalUrl.substring(0, 40)}...</strong><br>
                <small>${result.substring(0, 60)}...</small>
            `;
            batchResults.appendChild(item);
            batchResults.scrollTop = batchResults.scrollHeight;
        }

        function copyToClipboard() {
            if (currentResult) {
                copyText(currentResult, document.querySelector('.copy-btn'));
            }
        }

        function copyAllResults() {
            if (currentResult) {
                copyText(currentResult, document.getElementById('copyAllBtn'));
            }
        }

        function copyText(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = '✅ 已复制';
                button.style.background = 'rgba(76, 175, 80, 0.3)';

                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = 'rgba(255, 255, 255, 0.2)';
                }, 2000);
            }).catch(() => {
                // 降级复制方法
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);

                const originalText = button.textContent;
                button.textContent = '✅ 已复制';
                button.style.background = 'rgba(76, 175, 80, 0.3)';

                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = 'rgba(255, 255, 255, 0.2)';
                }, 2000);
            });
        }

        function testLink() {
            if (currentResult) {
                if (currentResult.includes('api') || currentResult.includes('需要') || currentResult.includes('密码')) {
                    alert('该链接为API接口或需要额外认证，无法直接测试');
                    return;
                }

                const testBtn = document.querySelector('.test-btn');
                const originalText = testBtn.textContent;
                testBtn.textContent = '🔍 测试中...';

                // 创建一个隐藏的iframe来测试链接
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = currentResult;
                document.body.appendChild(iframe);

                // 设置超时
                setTimeout(() => {
                    document.body.removeChild(iframe);
                    testBtn.textContent = '✅ 测试完成';

                    setTimeout(() => {
                        testBtn.textContent = originalText;
                    }, 2000);
                }, 3000);

                // 同时在新窗口打开
                window.open(currentResult, '_blank');
            }
        }

        function testAllLinks() {
            if (currentResult && currentResult.includes('\n')) {
                const links = currentResult.split('\n').filter(link => link.trim());
                const testAllBtn = document.getElementById('testAllBtn');
                const originalText = testAllBtn.textContent;

                testAllBtn.textContent = `🔍 测试中... (0/${links.length})`;

                // 逐个打开链接，间隔1秒
                links.forEach((link, index) => {
                    setTimeout(() => {
                        window.open(link.trim(), '_blank');
                        testAllBtn.textContent = `🔍 测试中... (${index + 1}/${links.length})`;

                        if (index === links.length - 1) {
                            setTimeout(() => {
                                testAllBtn.textContent = '✅ 全部测试完成';
                                setTimeout(() => {
                                    testAllBtn.textContent = originalText;
                                }, 3000);
                            }, 500);
                        }
                    }, index * 1000);
                });

                showInfo(`将在新窗口中打开 ${links.length} 个链接，请检查浏览器弹窗设置`);
            } else {
                testLink();
            }
        }

        // 高级转换功能
        function advancedConversion(url) {
            // 处理短链接
            if (url.includes('bit.ly') || url.includes('tinyurl.com') || url.includes('t.co')) {
                return {
                    success: false,
                    error: '检测到短链接，请先展开为完整链接'
                };
            }

            // 处理加密链接
            if (url.includes('密码') || url.includes('提取码')) {
                return {
                    success: false,
                    error: '检测到加密链接，请提供提取码'
                };
            }

            return { success: false };
        }



        // 链接验证功能
        function validateLink(url) {
            // 检查链接是否有效
            if (!url || url.length < 10) {
                return false;
            }

            // 检查是否为网盘链接
            const netdiskDomains = [
                'drive.google.com', 'onedrive.live.com', 'dropbox.com',
                'pan.baidu.com', 'lanzou', 'cloud.189.cn',
                'aliyundrive.com', 'pan.quark.cn', '123pan.com',
                'ctfile.com', 'weiyun.com', 'cowtransfer.com'
            ];

            return netdiskDomains.some(domain => url.includes(domain));
        }

        // 自动识别并提示
        function autoDetectPlatform(url) {
            for (const [domain, platform] of Object.entries(platforms)) {
                if (url.includes(domain)) {
                    return platform;
                }
            }
            return null;
        }

        // 支持回车键转换
        document.getElementById('shareLink').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                convertLink();
            }
        });

        // 密码输入框回车键支持
        document.getElementById('extractCode').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                convertLink();
            }
        });

        // 监听输入变化，自动检测是否需要密码
        document.getElementById('shareLink').addEventListener('input', function () {
            const url = this.value.trim();
            if (url && validateLink(url)) {
                const platform = autoDetectPlatform(url);
                if (platform && platform.needsPassword) {
                    showPasswordSection(platform.name);
                } else {
                    hidePasswordSection();
                }

                // 实时预览
                if (platform) {
                    showInfo(`检测到 ${platform.icon} ${platform.name}`);
                }
            } else {
                hidePasswordSection();
            }
        });

        // 自动粘贴功能
        document.getElementById('shareLink').addEventListener('focus', function () {
            if (this.value === '') {
                navigator.clipboard.readText().then(text => {
                    if (text && validateLink(text)) {
                        this.value = text;
                        // 自动显示检测到的平台
                        const platform = autoDetectPlatform(text);
                        if (platform) {
                            showInfo(`检测到 ${platform.icon} ${platform.name} 链接`);
                        }
                    }
                }).catch(() => {
                    // 静默失败
                });
            }
        });

        // 拖拽上传功能
        document.addEventListener('dragover', function (e) {
            e.preventDefault();
        });

        document.addEventListener('drop', function (e) {
            e.preventDefault();
            const text = e.dataTransfer.getData('text');
            if (validateLink(text)) {
                document.getElementById('shareLink').value = text;
                convertLink();
            }
        });

        // 显示信息提示
        function showInfo(message) {
            const infoDiv = document.createElement('div');
            infoDiv.className = 'info-toast';
            infoDiv.textContent = message;
            infoDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(76, 175, 80, 0.9);
                color: white;
                padding: 10px 20px;
                border-radius: 8px;
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
            `;

            document.body.appendChild(infoDiv);

            setTimeout(() => {
                infoDiv.remove();
            }, 3000);
        }

        // 添加快捷键支持
        document.addEventListener('keydown', function (e) {
            if (e.ctrlKey && e.key === 'v') {
                // Ctrl+V 自动粘贴并转换
                setTimeout(() => {
                    const input = document.getElementById('shareLink');
                    if (input.value && validateLink(input.value)) {
                        convertLink();
                    }
                }, 100);
            }
        });

        // 链接历史记录
        let linkHistory = [];

        function saveToHistory(originalUrl, directLink, platform) {
            const historyItem = {
                original: originalUrl,
                direct: directLink,
                platform: platform,
                timestamp: new Date().toISOString()
            };

            linkHistory.unshift(historyItem);
            if (linkHistory.length > 10) {
                linkHistory.pop();
            }

            // 保存到本地存储
            try {
                // 由于不能使用localStorage，使用内存存储
                window.linkHistory = linkHistory;
            } catch (e) {
                // 静默失败
            }
        }

        // 显示历史记录
        function showHistory() {
            if (linkHistory.length === 0) {
                showInfo('暂无转换历史');
                return;
            }

            const historyHtml = linkHistory.map((item, index) =>
                `<div class="history-item" onclick="useHistoryItem(${index})">
                    <strong>${item.platform}</strong><br>
                    <small>${item.original.substring(0, 50)}...</small>
                </div>`
            ).join('');

            // 这里可以显示历史记录的模态框
            showInfo('历史记录功能可在控制台查看');
            console.log('转换历史:', linkHistory);
        }

        // 使用历史记录项
        function useHistoryItem(index) {
            const item = linkHistory[index];
            if (item) {
                document.getElementById('shareLink').value = item.original;
                currentResult = item.direct;
                showResult({
                    platform: item.platform,
                    icon: '📋',
                    directLink: item.direct,
                    originalUrl: item.original
                });
            }
        }

        // URL参数支持
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const shareUrl = urlParams.get('url');
            if (shareUrl) {
                document.getElementById('shareLink').value = decodeURIComponent(shareUrl);
                convertLink();
            }
        }

        // 页面加载时检查URL参数
        window.addEventListener('load', checkUrlParams);

        // 添加更多平台支持
        const additionalPlatforms = {
            '4shared.com': {
                name: '4shared',
                icon: '📁',
                patterns: [
                    {
                        regex: /4shared\.com\/file\/([a-zA-Z0-9_-]+)/,
                        converter: (match, originalUrl) => {
                            const fileId = match[1];
                            return `https://4shared.com/get/${fileId}`;
                        }
                    }
                ]
            },
            'uploaded.net': {
                name: 'Uploaded',
                icon: '⬆️',
                patterns: [
                    {
                        regex: /uploaded\.net\/file\/([a-zA-Z0-9_-]+)/,
                        converter: (match, originalUrl) => {
                            const fileId = match[1];
                            return `https://uploaded.net/file/${fileId}/download`;
                        }
                    }
                ]
            },
            'jianguoyun.com': {
                name: '坚果云',
                icon: '🥜',
                patterns: [
                    {
                        regex: /jianguoyun\.com\/p\/([a-zA-Z0-9_-]+)/,
                        converter: (match, originalUrl) => {
                            const shareId = match[1];
                            return `https://jianguoyun.com/api/share/download?share_id=${shareId}`;
                        }
                    }
                ]
            },
            'terabox.com': {
                name: 'TeraBox',
                icon: '📦',
                patterns: [
                    {
                        regex: /terabox\.com\/s\/([a-zA-Z0-9_-]+)/,
                        converter: (match, originalUrl) => {
                            const shareId = match[1];
                            return `https://terabox.com/api/download?share_id=${shareId}`;
                        }
                    }
                ]
            },
            'send.firefox.com': {
                name: 'Firefox Send',
                icon: '🦊',
                patterns: [
                    {
                        regex: /send\.firefox\.com\/download\/([a-zA-Z0-9_-]+)/,
                        converter: (match, originalUrl) => {
                            return originalUrl; // Firefox Send 本身就是直链
                        }
                    }
                ]
            },
            'wetransfer.com': {
                name: 'WeTransfer',
                icon: '📤',
                patterns: [
                    {
                        regex: /wetransfer\.com\/downloads\/([a-zA-Z0-9_-]+)/,
                        converter: (match, originalUrl) => {
                            const transferId = match[1];
                            return `https://wetransfer.com/api/v4/transfers/${transferId}/download`;
                        }
                    }
                ]
            },
            'sendspace.com': {
                name: 'SendSpace',
                icon: '🚀',
                patterns: [
                    {
                        regex: /sendspace\.com\/file\/([a-zA-Z0-9_-]+)/,
                        converter: (match, originalUrl) => {
                            const fileId = match[1];
                            return `https://sendspace.com/file/${fileId}/download`;
                        }
                    }
                ]
            },
            'mediafire.com': {
                name: 'MediaFire',
                icon: '🔥',
                patterns: [
                    {
                        regex: /mediafire\.com\/file\/([a-zA-Z0-9_-]+)/,
                        converter: (match, originalUrl) => {
                            const fileId = match[1];
                            return `https://download${Math.floor(Math.random() * 1000)}.mediafire.com/file/${fileId}`;
                        }
                    }
                ]
            },
            'mega.nz': {
                name: 'MEGA',
                icon: '🛡️',
                patterns: [
                    {
                        regex: /mega\.nz\/#!([a-zA-Z0-9_-]+)!([a-zA-Z0-9_-]+)/,
                        converter: (match, originalUrl) => {
                            return `https://mega.nz/api/download?id=${match[1]}&key=${match[2]}`;
                        }
                    }
                ]
            },
            'zippyshare.com': {
                name: 'ZippyShare',
                icon: '⚡',
                patterns: [
                    {
                        regex: /zippyshare\.com\/v\/([a-zA-Z0-9_-]+)/,
                        converter: (match, originalUrl) => {
                            const fileId = match[1];
                            return `https://zippyshare.com/download/${fileId}`;
                        }
                    }
                ]
            }
        };

        // 合并平台配置
        Object.assign(platforms, additionalPlatforms);

        // 更新平台指示器
        function updatePlatformIndicators() {
            const platformsContainer = document.querySelector('.platform-indicators');
            const additionalBadges = Object.values(additionalPlatforms).map(platform =>
                `<div class="platform-badge">${platform.name}</div>`
            ).join('');

            platformsContainer.innerHTML += additionalBadges;
        }

        // 页面加载完成后更新指示器
        window.addEventListener('load', updatePlatformIndicators);

        // 性能优化：防抖处理
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 应用防抖到转换函数
        const debouncedConvert = debounce(convertLink, 300);

        // 实时预览功能
        document.getElementById('shareLink').addEventListener('input', function () {
            const url = this.value.trim();
            if (url && validateLink(url)) {
                const platform = autoDetectPlatform(url);
                if (platform) {
                    showInfo(`检测到 ${platform.icon} ${platform.name}`);
                }
            }
        });

        // 错误上报功能
        function reportError(error, url) {
            console.error('转换错误:', error, '链接:', url);
            // 这里可以添加错误上报逻辑
        }

        // 全局错误处理
        window.addEventListener('error', function (e) {
            reportError(e.error, document.getElementById('shareLink').value);
        });

        // 添加CSS动画
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            .history-item {
                padding: 10px;
                border-bottom: 1px solid rgba(255,255,255,0.1);
                cursor: pointer;
                transition: background 0.2s;
            }
            
            .history-item:hover {
                background: rgba(255,255,255,0.1);
            }
        `;
        document.head.appendChild(style);

        // 初始化完成提示
        console.log('智能网盘直链转换器已就绪！');
        console.log('支持的平台:', Object.keys(platforms));
    </script>
</body>

</html>